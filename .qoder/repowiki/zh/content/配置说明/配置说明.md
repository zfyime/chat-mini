# 配置说明

<cite>
**本文档引用的文件**  
- [src/config/constants.ts](file://src/config/constants.ts)
- [src/env.d.ts](file://src/env.d.ts)
- [src/pages/api/auth.ts](file://src/pages/api/auth.ts)
- [src/pages/api/generate.ts](file://src/pages/api/generate.ts)
- [src/utils/auth.ts](file://src/utils/auth.ts)
- [src/components/SystemRoleSettings.tsx](file://src/components/SystemRoleSettings.tsx)
- [hack/docker-env-replace.sh](file://hack/docker-env-replace.sh)
- [README.md](file://README.md)
</cite>

## 目录
1. [配置体系概述](#配置体系概述)
2. [环境变量配置](#环境变量配置)
3. [应用内常量配置](#应用内常量配置)
4. [密码与签名验证机制](#密码与签名验证机制)
5. [前端模型选择逻辑](#前端模型选择逻辑)
6. [配置最佳实践](#配置最佳实践)

## 配置体系概述

chat-mini 的配置体系由两部分构成：**环境变量** 和 **应用内常量**。环境变量用于部署时注入敏感信息和环境特定设置，而应用内常量则定义了应用的核心行为参数。两者共同决定了应用的功能、安全性和用户体验。

**Section sources**
- [README.md](file://README.md#L50-L55)

## 环境变量配置

环境变量是部署时通过 `.env` 文件或运行时注入的配置项，主要用于管理敏感信息和外部服务连接。以下是所有支持的环境变量及其详细说明。

### 支持的环境变量

| 变量名 | 说明 | 格式要求 | 默认值 |
| :--- | :--- | :--- | :--- |
| `OPENAI_API_KEY` | **必需**，用于调用 OpenAI API 的密钥。 | 有效的 OpenAI API 密钥字符串 | 无（必须设置） |
| `HTTPS_PROXY` | OpenAI API 的代理地址，用于网络受限环境。 | 标准代理 URL 格式，如 `http://127.0.0.1:7890` | 无 |
| `OPENAI_API_BASE_URL` | 自定义 OpenAI API 的基础 URL，可用于私有化部署或反向代理。 | 以 `http://` 或 `https://` 开头的有效 URL，末尾无斜杠 | `https://api.openai.com/v1` |
| `HEAD_SCRIPTS` | 在页面 `</head>` 标签前注入的脚本，常用于分析工具或监控代码。 | 完整的 HTML `<script>` 标签或内联 JavaScript 代码 | 无 |
| `PUBLIC_SECRET_KEY` | 用于生成和验证 API 请求签名的密钥，防止未授权访问。 | 复杂的随机字符串，建议长度大于 32 位 | 无 |
| `SITE_PASSWORD` | 网站访问密码，支持多个密码用英文逗号 `,` 分隔。留空则网站公开访问。 | 字符串，多个密码以逗号分隔 | 无 |
| `OPENAI_API_MODEL` | 默认使用的模型 ID，优先级高于 `DEFAULT_MODEL` 常量。 | 必须是 `AVAILABLE_MODELS` 列表中的 `id` 值 | 无 |

### 环境变量处理机制

在 Docker 部署场景中，`hack/docker-env-replace.sh` 脚本负责将环境变量注入到构建后的 JavaScript 文件中。该脚本遍历 `./dist` 目录下的所有 `.mjs` 文件，使用 `sed` 命令将占位符替换为实际的环境变量值。

```bash
for file in $(find ./dist -type f -name "*.mjs"); do
  sed "s|({}).OPENAI_API_KEY|\"$openai_api_key\"|g;
  s|({}).HTTPS_PROXY|\"$https_proxy\"|g;
  s|({}).OPENAI_API_BASE_URL|\"$openai_api_base_url\"|g;
  s|({}).HEAD_SCRIPTS|\"$head_scripts\"|g;
  s|({}).PUBLIC_SECRET_KEY|\"$public_secret_key\"|g;
  s|({}).OPENAI_API_MODEL|\"$openai_api_model\"|g;
  s|({}).SITE_PASSWORD|\"$site_password\"|g" $file > tmp
  mv tmp $file
done
```

此机制确保了环境变量在容器运行时被正确应用，同时避免了在源码中硬编码敏感信息。

**Section sources**
- [src/env.d.ts](file://src/env.d.ts#L3-L14)
- [hack/docker-env-replace.sh](file://hack/docker-env-replace.sh#L1-L30)

## 应用内常量配置

应用内常量定义在 `src/config/constants.ts` 文件中，用于控制应用的核心行为。这些常量在构建时被固化，修改后需重新构建应用。

### 核心常量说明

#### 对话与历史记录
- **`MAX_HISTORY_MESSAGES`**: 发送给 OpenAI API 的最大上下文消息数量，控制模型的上下文长度。当前值为 `9`。
- **`MAX_HISTORY_COUNT`**: 在本地浏览器中保留的最近历史会话数量。当会话数超过此值时，最旧的会话将被自动清除。当前值为 `25`。

#### 时间与性能
- **`AUTH_TIMEOUT`**: 签名验证的有效时间窗口，单位为毫秒。用于防止重放攻击，当前设置为 `5分钟`（300,000 毫秒）。
- **`SAVE_DEBOUNCE_TIME`**: 本地历史记录保存的防抖时间，单位为毫秒。避免频繁写入存储，当前值为 `500`。

#### 用户界面
- **`SCROLL_THRESHOLD`**: 滚动阈值，用于判断用户是否已滚动到底部，影响自动滚动行为。当前值为 `25`。
- **`SMOOTH_SCROLL_DELAY`**: 平滑滚动的延迟时间，单位为毫秒。当前值为 `300`。

#### 模型与参数
- **`DEFAULT_TEMPERATURE`**: 生成文本的随机性参数，默认值为 `0.6`，值越高输出越随机。
- **`DEFAULT_MODEL`**: 当 `OPENAI_API_MODEL` 环境变量未设置时的默认模型 ID。当前值为 `'gpt-4.1'`。

### 可选模型列表
`AVAILABLE_MODELS` 常量定义了前端 UI 中可供用户选择的模型列表。每个模型包含 `id` 和 `name` 两个字段，`id` 必须与 API 支持的模型 ID 一致。

```typescript
export const AVAILABLE_MODELS = [
  { id: 'gpt-4.1', name: 'OpenAI-4.1' },
  { id: 'gpt-5', name: 'OpenAI-5' },
  { id: 'gpt-4o', name: 'OpenAI-4o' },
  { id: 'o3', name: 'OpenAI-o3' },
  { id: 'DeepSeek-V3-0324', name: 'DeepSeek-V3' },
  { id: 'DeepSeek-R1-0528', name: 'DeepSeek-R1' },
  { id: 'grok-3', name: 'Grok-3' },
] as const
```

**Section sources**
- [src/config/constants.ts](file://src/config/constants.ts#L1-L37)

## 密码与签名验证机制

chat-mini 实现了双层安全机制：**访问密码** 和 **API 请求签名**，确保应用的安全性。

### 访问密码验证

访问密码由 `SITE_PASSWORD` 环境变量控制，其实现位于 `src/pages/api/auth.ts`。验证逻辑如下：
1. 从环境变量读取 `SITE_PASSWORD`，若未设置则允许公开访问。
2. 支持多个密码，通过逗号分隔。
3. 接收客户端提交的密码，与环境变量中的密码进行比对。

```typescript
const realPassword = import.meta.env.SITE_PASSWORD || ''
const passList = realPassword.split(',') || []

export const post: APIRoute = async(context) => {
  const body = await context.request.json()
  const { pass } = body
  return new Response(JSON.stringify({
    code: (!realPassword || pass === realPassword || passList.includes(pass)) ? 0 : -1,
  }))
}
```

### 签名验证流程

签名验证用于保护 `/api/generate` 接口，防止未授权的 API 调用。其核心是基于 SHA-256 的签名算法，流程如下：

1. **生成签名** (`generateSignature`):
   - 客户端使用时间戳 (`t`)、最后一条消息内容 (`m`) 和 `PUBLIC_SECRET_KEY` 构造签名原文：`{timestamp}:{lastMessage}:{secretKey}`。
   - 使用 SHA-256 算法对原文进行哈希，生成签名。

2. **验证签名** (`verifySignature`):
   - 服务端首先验证时间戳是否在 `AUTH_TIMEOUT`（5分钟）有效期内，防止重放攻击。
   - 使用相同的算法重新生成签名，并与客户端提供的签名进行比对。

```typescript
export const verifySignature = async(payload: AuthPayload, sign: string) => {
  if (Math.abs(payload.t - Date.now()) > CONFIG.AUTH_TIMEOUT) {
    return false
  }
  const payloadSign = await generateSignature(payload)
  return payloadSign === sign
}
```

该机制结合了时间戳和密钥，有效防止了签名被截获和重用。

**Section sources**
- [src/pages/api/auth.ts](file://src/pages/api/auth.ts#L1-L13)
- [src/utils/auth.ts](file://src/utils/auth.ts#L1-L35)

## 前端模型选择逻辑

前端模型选择逻辑由 `SystemRoleSettings` 组件实现，其核心是将 `AVAILABLE_MODELS` 常量与用户界面绑定。

### 实现原理

1. **状态管理**:
   - 使用 `useStorage` Hook 将用户选择的模型 ID 持久化存储在浏览器的 `localStorage` 中，键名为 `selected_model`。
   - 默认值为 `AVAILABLE_MODELS` 的第一个模型 ID。

2. **UI 渲染**:
   - 使用 `<select>` 元素渲染模型选择下拉框。
   - 通过 `For` 循环遍历 `AVAILABLE_MODELS`，为每个模型创建 `<option>` 项。

3. **事件处理**:
   - 当用户选择模型时，触发 `onChange` 事件，调用 `setChatModel` 更新状态和存储。

```tsx
const [chatModel, setChatModel] = useStorage('selected_model', AVAILABLE_MODELS[0].id)

<select
  value={chatModel()}
  onChange={e => setChatModel(e.currentTarget.value)}
>
  <For each={AVAILABLE_MODELS}>
    {model => <option value={model.id}>{model.name}</option>}
  </For>
</select>
```

### 后端模型校验

在 `src/pages/api/generate.ts` 中，后端会对客户端提交的模型进行严格校验：
1. 优先使用客户端提交的 `model` 参数，若未提供则使用 `OPENAI_API_MODEL` 环境变量或 `DEFAULT_MODEL` 常量。
2. 检查所选模型是否在 `allowedModels`（即 `AVAILABLE_MODELS` 的 `id` 列表）中。
3. 若模型不被允许，返回 `400 Bad Request` 错误。

```typescript
const allowedModels = AVAILABLE_MODELS.map(m => m.id)
const modelToUse = model || apiModel

if (!allowedModels.includes(modelToUse)) {
  return new Response(JSON.stringify({
    error: { message: `Model ${modelToUse} is not allowed.` },
  }), { status: 400 })
}
```

**Section sources**
- [src/components/SystemRoleSettings.tsx](file://src/components/SystemRoleSettings.tsx#L1-L105)
- [src/pages/api/generate.ts](file://src/pages/api/generate.ts#L1-L70)

## 配置最佳实践

### 敏感信息保护
- **API 密钥**: 始终通过环境变量注入 `OPENAI_API_KEY` 和 `PUBLIC_SECRET_KEY`，切勿在代码或版本控制中硬编码。
- **密码管理**: 设置强密码，并通过逗号分隔支持多个密码，便于团队协作。
- **Docker 安全**: 在 `docker-compose.yml` 中使用 `secrets` 或 `environment` 的外部文件方式管理敏感信息。

### 多模型配置示例
```env
# .env 文件示例
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_API_MODEL=gpt-4o
SITE_PASSWORD=mysecretpassword,team123
PUBLIC_SECRET_KEY=this_is_a_very_long_and_complex_secret_key_12345
AVAILABLE_MODELS=gpt-4o,gpt-4.1,DeepSeek-V3-0324
```

### 代理设置技巧
- **网络代理**: 在国内部署时，通过 `HTTPS_PROXY=http://proxy-server:port` 配置代理。
- **自定义 API 地址**: 使用 `OPENAI_API_BASE_URL=https://your-proxy-domain.com/v1` 实现私有化代理，提高稳定性和安全性。

### 推荐部署配置模板
```env
# 生产环境推荐配置
OPENAI_API_KEY=your_openai_api_key_here
HTTPS_PROXY=http://127.0.0.1:7890
OPENAI_API_BASE_URL=https://api.openai.com/v1
PUBLIC_SECRET_KEY=generate_a_strong_random_string_here
SITE_PASSWORD=strong_password1,team_password2
OPENAI_API_MODEL=gpt-4o
HEAD_SCRIPTS=<script src="https://analytics.example.com/script.js"></script>
```

**Section sources**
- [README.md](file://README.md#L50-L90)
- [hack/docker-env-replace.sh](file://hack/docker-env-replace.sh#L1-L30)